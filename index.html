<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <title>coldout — photo archive</title>
  <style>
    html { scroll-behavior: smooth; }
    body { background-color: #000; overflow-x: hidden; }
    section { scroll-margin-top: 100px; }
    
    .reveal {
      opacity: 0;
      transform: translateY(50px);
      transition: all 1.2s cubic-bezier(0.2, 1, 0.3, 1);
    }
    .reveal.active { opacity: 1; transform: translateY(0); }

    .masonry-grid { column-count: 2; column-gap: 0.75rem; }
    @media (min-width: 768px) { .masonry-grid { column-count: 3; } }
    @media (min-width: 1024px) { .masonry-grid { column-count: 4; } }
    
    .masonry-item { 
      break-inside: avoid; 
      margin-bottom: 0.75rem; 
      background: #050505;
      position: relative;
      aspect-ratio: 4/5; 
      transition: aspect-ratio 0.3s ease;
    }

    #lightbox {
      display: none; position: fixed; inset: 0; z-index: 200;
      background: rgba(0,0,0,0.9); backdrop-filter: blur(20px);
      cursor: zoom-out; align-items: center; justify-content: center;
    }
    #lightbox.active { display: flex; }
    #lightbox img { max-width: 90%; max-height: 90%; object-fit: contain; }

    /* Полоса прогресса */
    #progress-bar {
      position: fixed; top: 64px; left: 0; height: 1px;
      background: #fff; width: 0%; z-index: 150;
      transition: width 0.4s ease, opacity 0.4s ease;
      box-shadow: 0 0 10px rgba(255,255,255,0.5);
    }

    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: #000; }
    ::-webkit-scrollbar-thumb { background: #18181b; }
  </style>
</head>
<body class="text-zinc-400 font-sans selection:bg-zinc-800">

  <nav class="fixed top-0 left-0 w-full px-6 py-4 md:px-10 flex flex-row justify-between items-center z-50 bg-black/60 backdrop-blur-md border-b border-white/5">
    <div class="text-white tracking-[0.2em] lowercase font-light text-sm md:text-base cursor-pointer" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">coldout</div>
    <div id="nav-years" class="flex items-center space-x-4 md:space-x-6 text-[10px] tracking-[0.1em] lowercase font-light overflow-x-auto"></div>
  </nav>

  <div id="progress-bar" class="opacity-0"></div>

  <div id="lightbox" onclick="closeLightbox()">
    <img id="lightbox-img" src="" alt="">
  </div>

  <div id="gallery-overlay" class="hidden fixed inset-0 bg-black z-[100] overflow-y-auto p-6 md:p-20">
    <div class="flex justify-between items-baseline mb-16 max-w-[1600px] mx-auto">
      <div class="flex items-baseline gap-4">
        <h2 id="gallery-title" class="text-white text-3xl font-thin lowercase tracking-tighter"></h2>
        <span id="gallery-counter" class="text-[10px] text-zinc-600 tracking-widest uppercase"></span>
      </div>
      <button onclick="closeGallery()" class="text-zinc-600 hover:text-white uppercase text-[9px] tracking-[0.3em] transition-colors border-b border-zinc-800 hover:border-white pb-1">close</button>
    </div>
    <div id="gallery-grid" class="masonry-grid max-w-[1600px] mx-auto pb-20"></div>
  </div>

  <main id="main-content" class="pt-24 px-6 md:px-20 max-w-[1600px] mx-auto">
    <div id="years-container"></div>
  </main>

  <script>
    const GITHUB_USER = "coldoutt";
    const GITHUB_REPO = "web";
    const BRANCH = "main";
    const RAW_BASE = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${BRANCH}/photo`;

    async function initSite() {
      const container = document.getElementById('years-container');
      try {
        const response = await fetch(`data.json?v=${new Date().getTime()}`);
        const data = await response.json();
        const years = Object.keys(data).sort((a, b) => b - a);

        years.forEach(year => {
          const section = document.createElement('section');
          section.id = `year-${year}`;
          section.className = 'mb-24 reveal';
          
          const tripsHtml = data[year].map(trip => {
            const folderNum = trip.folder.split('_')[0];
            const randomIdx = Math.floor(Math.random() * trip.count) + 1;
            const photoNum = String(randomIdx).padStart(2, '0');
            const fileName = `${year}_${folderNum}_${photoNum}.jpg`;
            const coverUrl = `${RAW_BASE}/${year}/${trip.folder}/${fileName}`;
            
            return `
              <div onclick="openGallery('${trip.title}', '${year}', '${trip.folder}', '${folderNum}', ${trip.count})" class="group cursor-pointer">
                <div class="aspect-[4/5] bg-zinc-900 overflow-hidden mb-1 relative block">
                  <img src="${coverUrl}" class="object-cover w-full h-full grayscale group-hover:grayscale-0 transition-all duration-1000">
                </div>
                <h3 class="text-white text-3xl font-thin lowercase tracking-tighter opacity-60 group-hover:opacity-100 transition-opacity duration-500 leading-tight">${trip.title}</h3>
              </div>
            `;
          }).join('');

          section.innerHTML = `<div class="border-b border-zinc-900 pb-2 mb-10"><h2 class="text-5xl md:text-6xl font-extralight text-white tracking-tighter">${year}</h2></div>
                               <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10">${tripsHtml}</div>`;
          container.appendChild(section);
        });

        const observer = new IntersectionObserver((entries) => {
          entries.forEach(entry => { if (entry.isIntersecting) entry.target.classList.add('active'); });
        }, { threshold: 0.1 });
        document.querySelectorAll('.reveal').forEach(el => observer.observe(el));

      } catch (e) { console.error(e); }
    }

    async function openGallery(title, year, folderFull, folderNum, count) {
      const grid = document.getElementById('gallery-grid');
      const progressBar = document.getElementById('progress-bar');
      const counter = document.getElementById('gallery-counter');
      
      document.getElementById('gallery-title').innerText = title;
      grid.innerHTML = '';
      counter.innerText = `0 / ${count}`;
      
      // Показываем индикатор
      progressBar.style.width = '0%';
      progressBar.classList.remove('opacity-0');
      
      document.getElementById('gallery-overlay').classList.remove('hidden');
      document.body.style.overflow = 'hidden';

      const items = [];
      for (let i = 1; i <= count; i++) {
        const item = document.createElement('div');
        item.className = 'masonry-item';
        grid.appendChild(item);
        items.push(item);
      }

      for (let i = 1; i <= count; i++) {
        const photoNum = String(i).padStart(2, '0');
        const fileName = `${year}_${folderNum}_${photoNum}.jpg`;
        const imgUrl = `${RAW_BASE}/${year}/${folderFull}/${fileName}`;
        
        await new Promise((resolve) => {
          const img = new Image();
          img.src = imgUrl;
          img.className = 'w-full h-auto opacity-0 transition-opacity duration-700 cursor-zoom-in block';
          
          img.onload = () => {
            items[i-1].style.aspectRatio = 'auto';
            items[i-1].appendChild(img);
            setTimeout(() => img.classList.replace('opacity-0', 'opacity-60'), 10);
            img.classList.add('hover:opacity-100');
            img.onclick = () => openLightbox(imgUrl);
            
            // Обновляем прогресс
            const percent = (i / count) * 100;
            progressBar.style.width = `${percent}%`;
            counter.innerText = `${i} / ${count}`;
            
            resolve();
          };
          img.onerror = () => {
            items[i-1].innerHTML = `<div class="text-[8px] p-4 text-zinc-800">Error: ${fileName}</div>`;
            resolve(); 
          };
        });
      }

      // Скрываем полосу после завершения
      setTimeout(() => progressBar.classList.add('opacity-0'), 500);
    }

    function closeGallery() { 
      document.getElementById('gallery-overlay').classList.add('hidden'); 
      document.body.style.overflow = 'auto';
      document.getElementById('progress-bar').classList.add('opacity-0');
    }
    
    function openLightbox(src) { document.getElementById('lightbox-img').src = src; document.getElementById('lightbox').classList.add('active'); }
    function closeLightbox() { document.getElementById('lightbox').classList.remove('active'); }

    initSite();
  </script>
</body>
</html>